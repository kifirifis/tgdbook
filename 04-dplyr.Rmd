Manipulación de datos con `dplyr`
=================================

Working draft...

En este capítulo se realiza una breve introducción al paquete  [`dplyr`](https://dplyr.tidyverse.org/index.html). 
Para mas información, ver por ejemplo la 'vignette' del paquete:  

[Introduction to dplyr](https://cran.rstudio.com/web/packages/dplyr/vignettes/dplyr.html),

o el Capítulo [5 Data transformation](http://r4ds.had.co.nz/transform.html) del libro:

[R for Data Science](http://r4ds.had.co.nz).


El paquete **dplyr**
--------------------

```{r message=FALSE}
library(dplyr)
```

**dplyr** Permite sustituir funciones base de R (como `split()`, `subset()`, 
`apply()`, `sapply()`, `lapply()`, `tapply()` y `aggregate()`)
mediante una "gramática" más sencilla para la manipulación de datos:

* `select()` seleccionar variables/columnas (también `rename()`).
* `mutate()` crear variables/columnas (también `transmute()`).
* `filter()` seleccionar casos/filas (también `slice()`).
* `arrange()`  ordenar o organizar casos/filas.
* `summarise()` resumir valores.
* `group_by()` permite operaciones por grupo empleando el concepto
"dividir-aplicar-combinar" (`ungroup()` elimina el agrupamiento).

Puede trabajar con conjuntos de datos en distintos formatos:
     
* `data.frame`, `data.table`, `tibble`, ...
* bases de datos relacionales (lenguaje SQL), ...
* bases de datos *Hadoop* (paquete `plyrmr`).

En lugar de operar sobre vectores como las funciones base,
opera sobre objetos de este tipo (solo nos centraremos en `data.frame`).

### Datos de ejemplo

El fichero *empleados.RData* contiene datos de empleados de un banco.
Supongamos por ejemplo que estamos interesados en estudiar si hay
discriminación por cuestión de sexo o raza.

```{r, echo=FALSE}
load("data/empleados.RData")
# Listamos las etiquetas
# data.frame(Etiquetas = attr(empleados, "variable.labels"))  
# Eliminamos las etiquetas para que no molesten...
# attr(empleados, "variable.labels") <- NULL                  
```


Operaciones con variables (columnas)
------------------------------------

### Seleccionar variables con **select()**

```{r }
emplea2 <- select(empleados, id, sexo, minoria, tiempemp, salini, salario)
head(emplea2)
```

Se puede cambiar el nombre (ver también *?rename()*)

```{r }
head(select(empleados, sexo, noblanca = minoria, salario))
```

Se pueden emplear los nombres de variables como índices:

```{r }
head(select(empleados, sexo:salario))
head(select(empleados, -(sexo:salario)))
```

Hay opciones para considerar distintos criterios: `starts_with()`, `ends_with()`, 
`contains()`, `matches()`, `one_of()` (ver *?select*).

```{r }
head(select(empleados, starts_with("s")))
```

### Generar nuevas variables con **mutate()**

```{r }
head(mutate(emplea2, incsal = salario - salini, tsal = incsal/tiempemp ))
```


Operaciones con casos (filas)
-----------------------------

### Seleccionar casos con **filter()**

```{r }
head(filter(emplea2, sexo == "Mujer", minoria == "Sí"))
```

### Organizar casos con **arrange()**

```{r }
head(arrange(emplea2, salario))
head(arrange(emplea2, desc(salini), salario))
```


Resumir valores con **summarise()**
-----------------------------------

```{r }
summarise(empleados, sal.med = mean(salario), n = n())
```


Agrupar casos con **group_by()**
-----------------------------

```{r }
summarise(group_by(empleados, sexo, minoria), sal.med = mean(salario), n = n())
```


Operador *pipe* **%>%** (tubería, redirección)
-----------------------------
Este operador le permite canalizar la salida de una función a la entrada de otra función. 
`segundo(primero(datos))` se traduce en `datos %>% primero %>% segundo`
(lectura de funciones de izquierda a derecha).

Ejemplos:

```{r }
empleados %>%  filter(catlab == "Directivo") %>%
          group_by(sexo, minoria) %>%
          summarise(sal.med = mean(salario), n = n())

empleados %>% select(sexo, catlab, salario) %>%
          filter(catlab != "Seguridad") %>%
          group_by(catlab) %>%
          mutate(saldif = salario - mean(salario)) %>%
          ungroup() %>%
          boxplot(saldif ~ sexo*droplevels(catlab), data = .)
abline(h = 0, lty = 2)
```

Operaciones con tablas de datos
-------------------------------

[Join two tbls together](https://dplyr.tidyverse.org/reference/join.html)

[Two-table verbs](https://dplyr.tidyverse.org/articles/two-table.html)

Bases de datos con dplyr
------------------------

[Databases using R](https://db.rstudio.com)

[dplyr as a database interface](https://db.rstudio.com/overview)

[Databases using dplyr](https://db.rstudio.com/dplyr)

[Introduction to dbplyr](https://dbplyr.tidyverse.org/articles/dbplyr.html)

[SQL databases and R](https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html), [Data Carpentry](https://datacarpentry.org/R-ecology-lesson/index.html)

[R and Data – When Should we Use Relational Databases? ](https://intellixus.com/2018/06/29/r-and-data-when-should-we-use-relational-databases)


--------------

Una alternativa (más rápida) es emplear
[data.table](https://rdatatable.gitlab.io/data.table).
